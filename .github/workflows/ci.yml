name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

env:
  FLUTTER_VERSION: '3.24.0'
  RUST_VERSION: 'stable'

jobs:
  # ============================================
  # Rust Core 测试和构建
  # ============================================
  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxrandr-dev libxcursor-dev libxi-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Run tests
        run: cargo test --all --verbose
      
      - name: Build release
        run: cargo build --release

  # ============================================
  # Flutter 测试
  # ============================================
  flutter-test:
    name: Flutter Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
      
      - name: Run tests
        run: |
          set +e
          timeout 300 flutter test --coverage 2>&1 | tee test_output.txt
          TEST_EXIT=$?
          # 强制终止可能残留的 dart 进程
          pkill -f "dart" || true
          if grep -q "tests passed" test_output.txt; then
            echo "✅ All tests passed"
            exit 0
          elif [ $TEST_EXIT -eq 124 ]; then
            echo "⚠️ Tests timed out but may have passed"
            if grep -q "All tests passed" test_output.txt; then
              exit 0
            fi
            exit 1
          else
            exit $TEST_EXIT
          fi
        timeout-minutes: 8
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: flutter-client/coverage/lcov.info
          flags: flutter
          fail_ci_if_error: false

  # ============================================
  # 微信小程序测试
  # ============================================
  miniprogram-test:
    name: WeChat Miniprogram Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wechat-miniprogram
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: wechat-miniprogram/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test -- --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: wechat-miniprogram/coverage/lcov.info
          flags: miniprogram
          fail_ci_if_error: false


  # ============================================
  # Flutter 多平台构建
  # ============================================
  build-android:
    name: Build Android
    needs: [rust-test, flutter-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle
        run: flutter build appbundle --release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: flutter-client/build/app/outputs/flutter-apk/app-release.apk
      
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: flutter-client/build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS
    needs: [rust-test, flutter-test]
    runs-on: macos-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign
      
      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: flutter-client/build/ios/iphoneos/

  build-web:
    name: Build Web
    needs: [rust-test, flutter-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Web
        run: flutter build web --release
      
      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: flutter-client/build/web/

  build-windows:
    name: Build Windows
    needs: [rust-test, flutter-test]
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Windows
        run: flutter build windows --release
      
      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Package Windows executable
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outputDir = "build/windows/x64/runner/Release"
          $packageName = "RemoteDesktop-$version-windows-x64"
          
          # 创建打包目录
          New-Item -ItemType Directory -Force -Path "dist"
          
          # 复制所有文件到打包目录
          Copy-Item -Recurse "$outputDir/*" "dist/$packageName/"
          
          # 创建 zip 包
          Compress-Archive -Path "dist/$packageName" -DestinationPath "dist/$packageName.zip"
      
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: flutter-client/dist/*.zip

  build-macos:
    name: Build macOS
    needs: [rust-test, flutter-test]
    runs-on: macos-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build macOS
        run: flutter build macos --release
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Package macOS app
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="remote_desktop_client"
          DMG_NAME="RemoteDesktop-$VERSION-macos"
          
          mkdir -p dist
          
          # 创建 DMG
          cd build/macos/Build/Products/Release
          
          # 创建临时目录用于 DMG
          mkdir -p dmg_temp
          cp -R "$APP_NAME.app" dmg_temp/
          
          # 创建 DMG 文件
          hdiutil create -volname "$APP_NAME" -srcfolder dmg_temp -ov -format UDZO "../../../../../dist/$DMG_NAME.dmg"
          
          # 同时创建 zip 备份
          zip -r "../../../../../dist/$DMG_NAME.zip" "$APP_NAME.app"
      
      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            flutter-client/dist/*.dmg
            flutter-client/dist/*.zip

  build-linux:
    name: Build Linux
    needs: [rust-test, flutter-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libayatana-appindicator3-dev libappindicator3-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Linux
        run: flutter build linux --release
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Package Linux executable
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_NAME="RemoteDesktop-$VERSION-linux-x64"
          
          mkdir -p dist
          
          # 复制 bundle 到打包目录
          cp -r build/linux/x64/release/bundle "dist/$PACKAGE_NAME"
          
          # 创建启动脚本
          cat > "dist/$PACKAGE_NAME/run.sh" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$SCRIPT_DIR"
          ./remote_desktop_client
          EOF
          chmod +x "dist/$PACKAGE_NAME/run.sh"
          chmod +x "dist/$PACKAGE_NAME/remote_desktop_client"
          
          # 创建 tar.gz 包
          cd dist
          tar -czvf "$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME"
      
      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: flutter-client/dist/*.tar.gz


  # ============================================
  # 发布 Release
  # ============================================
  release:
    name: Create Release
    needs: [build-android, build-ios, build-web, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Prepare release files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p release
          
          # Android APK
          cp artifacts/android-apk/*.apk "release/RemoteDesktop-$VERSION-android.apk" 2>/dev/null || \
            (cd artifacts/android-apk && zip -r "../../release/RemoteDesktop-$VERSION-android-apk.zip" .)
          
          # Android AAB
          cp artifacts/android-aab/*.aab "release/RemoteDesktop-$VERSION-android.aab" 2>/dev/null || \
            (cd artifacts/android-aab && zip -r "../../release/RemoteDesktop-$VERSION-android-aab.zip" .)
          
          # iOS
          cd artifacts/ios-build && zip -r "../../release/RemoteDesktop-$VERSION-ios.zip" . && cd ../..
          
          # Web
          cd artifacts/web-build && zip -r "../../release/RemoteDesktop-$VERSION-web.zip" . && cd ../..
          
          # Windows (已经是 zip)
          cp artifacts/windows-build/*.zip release/ 2>/dev/null || true
          
          # macOS (DMG 和 zip)
          cp artifacts/macos-build/*.dmg release/ 2>/dev/null || true
          cp artifacts/macos-build/*.zip release/ 2>/dev/null || true
          
          # Linux (已经是 tar.gz)
          cp artifacts/linux-build/*.tar.gz release/ 2>/dev/null || true
          
          # 列出所有发布文件
          echo "=== Release files ==="
          ls -la release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Remote Desktop ${{ steps.version.outputs.version }}"
          body: |
            ## 下载说明 / Download Instructions
            
            | 平台 / Platform | 文件 / File | 说明 / Notes |
            |----------------|-------------|--------------|
            | Windows | `*-windows-x64.zip` | 解压后运行 exe |
            | macOS | `*-macos.dmg` | 双击安装 |
            | Linux | `*-linux-x64.tar.gz` | 解压后运行 `./run.sh` |
            | Android | `*-android.apk` | 直接安装 |
            | iOS | `*-ios.zip` | 需要 Xcode 签名 |
            | Web | `*-web.zip` | 部署到 Web 服务器 |
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # 部署 Web 到 GitHub Pages
  # ============================================
  deploy-web:
    name: Deploy to GitHub Pages
    needs: [build-web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build/
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
      
      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: web-build/
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
