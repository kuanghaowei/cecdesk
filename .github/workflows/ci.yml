name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

env:
  FLUTTER_VERSION: '3.24.0'
  RUST_VERSION: 'stable'

jobs:
  # ============================================
  # Rust Core æµ‹è¯•å’Œæ„å»º
  # ============================================
  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxrandr-dev libxcursor-dev libxi-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Run tests
        run: cargo test --all --verbose
      
      - name: Build release
        run: cargo build --release

  # ============================================
  # Flutter æµ‹è¯•
  # ============================================
  flutter-test:
    name: Flutter Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
      
      - name: Run tests
        run: |
          set +e
          timeout 300 flutter test --coverage 2>&1 | tee test_output.txt
          TEST_EXIT=$?
          # å¼ºåˆ¶ç»ˆæ­¢å¯èƒ½æ®‹ç•™çš„ dart è¿›ç¨‹
          pkill -f "dart" || true
          if grep -q "tests passed" test_output.txt; then
            echo "âœ… All tests passed"
            exit 0
          elif [ $TEST_EXIT -eq 124 ]; then
            echo "âš ï¸ Tests timed out but may have passed"
            if grep -q "All tests passed" test_output.txt; then
              exit 0
            fi
            exit 1
          else
            exit $TEST_EXIT
          fi
        timeout-minutes: 8
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: flutter-client/coverage/lcov.info
          flags: flutter
          fail_ci_if_error: false

  # ============================================
  # å¾®ä¿¡å°ç¨‹åºæµ‹è¯•
  # ============================================
  miniprogram-test:
    name: WeChat Miniprogram Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wechat-miniprogram
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: wechat-miniprogram/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test -- --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: wechat-miniprogram/coverage/lcov.info
          flags: miniprogram
          fail_ci_if_error: false


  # ============================================
  # Flutter å¤šå¹³å°æ„å»º
  # ============================================
  build-android:
    name: Build Android
    needs: [rust-test, flutter-test, auto-tag]
    runs-on: ubuntu-latest
    if: always() && (needs.auto-tag.outputs.tag_created == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      # Gradle ç¼“å­˜ - å¤§å¹…åŠ é€Ÿæ„å»º
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            flutter-client/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ needs.auto-tag.outputs.tag_created }}" == "true" ]]; then
            echo "version=${{ needs.auto-tag.outputs.new_tag }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      # åªæ„å»º APKï¼ˆæ›´å¿«ï¼‰ï¼ŒAAB ä»…åœ¨ tag å‘å¸ƒæ—¶æ„å»º
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle (only for releases)
        if: startsWith(github.ref, 'refs/tags/')
        run: flutter build appbundle --release
      
      - name: Rename APK with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-release.apk "dist/RemoteDesktop-$VERSION-android.apk"
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: flutter-client/dist/*.apk
      
      - name: Upload AAB
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: flutter-client/build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS
    needs: [rust-test, flutter-test, auto-tag]
    runs-on: macos-latest
    if: always() && (needs.auto-tag.outputs.tag_created == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign
      
      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: flutter-client/build/ios/iphoneos/

  build-web:
    name: Build Web
    needs: [rust-test, flutter-test, auto-tag]
    runs-on: ubuntu-latest
    if: always() && (needs.auto-tag.outputs.tag_created == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Web
        run: flutter build web --release
      
      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: flutter-client/build/web/

  build-windows:
    name: Build Windows
    needs: [rust-test, flutter-test, auto-tag]
    runs-on: windows-latest
    if: always() && (needs.auto-tag.outputs.tag_created == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Windows
        run: flutter build windows --release
      
      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Package Windows executable
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outputDir = "build/windows/x64/runner/Release"
          $packageName = "RemoteDesktop-$version-windows-x64"
          
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          New-Item -ItemType Directory -Force -Path "dist"
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•
          Copy-Item -Recurse "$outputDir/*" "dist/$packageName/"
          
          # åˆ›å»º zip åŒ…
          Compress-Archive -Path "dist/$packageName" -DestinationPath "dist/$packageName.zip"
      
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: flutter-client/dist/*.zip

  build-macos:
    name: Build macOS
    needs: [rust-test, flutter-test, auto-tag]
    runs-on: macos-latest
    if: always() && (needs.auto-tag.outputs.tag_created == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build macOS
        run: flutter build macos --release
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Package macOS app
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="remote_desktop_client"
          DMG_NAME="RemoteDesktop-$VERSION-macos"
          
          mkdir -p dist
          
          # åˆ›å»º DMG
          cd build/macos/Build/Products/Release
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äº DMG
          mkdir -p dmg_temp
          cp -R "$APP_NAME.app" dmg_temp/
          
          # åˆ›å»º DMG æ–‡ä»¶
          hdiutil create -volname "$APP_NAME" -srcfolder dmg_temp -ov -format UDZO "../../../../../dist/$DMG_NAME.dmg"
          
          # åŒæ—¶åˆ›å»º zip å¤‡ä»½
          zip -r "../../../../../dist/$DMG_NAME.zip" "$APP_NAME.app"
      
      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            flutter-client/dist/*.dmg
            flutter-client/dist/*.zip

  build-linux:
    name: Build Linux
    needs: [rust-test, flutter-test, auto-tag]
    runs-on: ubuntu-latest
    if: always() && (needs.auto-tag.outputs.tag_created == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libayatana-appindicator3-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Linux
        run: flutter build linux --release
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Package Linux executable
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_NAME="RemoteDesktop-$VERSION-linux-x64"
          
          mkdir -p dist
          
          # å¤åˆ¶ bundle åˆ°æ‰“åŒ…ç›®å½•
          cp -r build/linux/x64/release/bundle "dist/$PACKAGE_NAME"
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > "dist/$PACKAGE_NAME/run.sh" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          cd "$SCRIPT_DIR"
          ./remote_desktop_client
          EOF
          chmod +x "dist/$PACKAGE_NAME/run.sh"
          chmod +x "dist/$PACKAGE_NAME/remote_desktop_client"
          
          # åˆ›å»º tar.gz åŒ…
          cd dist
          tar -czvf "$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME"
      
      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: flutter-client/dist/*.tar.gz


  # ============================================
  # è‡ªåŠ¨åˆ›å»º Tagï¼ˆä»…åœ¨ main åˆ†æ”¯æˆåŠŸæ„å»ºåï¼‰
  # ============================================
  auto-tag:
    name: Auto Create Tag
    needs: [rust-test, flutter-test, miniprogram-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
      tag_created: ${{ steps.tag.outputs.tag_created }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get current version
        id: current_version
        run: |
          # è·å–æœ€æ–°çš„ tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # è§£æç‰ˆæœ¬å·
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
      
      - name: Determine version bump
        id: version_bump
        run: |
          # æ£€æŸ¥æäº¤ä¿¡æ¯æ¥å†³å®šç‰ˆæœ¬å‡çº§ç±»å‹
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          if [[ "$COMMIT_MSG" =~ ^(feat|feature)(\(.+\))?!: ]] || [[ "$COMMIT_MSG" =~ BREAKING[[:space:]]CHANGE ]]; then
            echo "bump_type=major" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" =~ ^(feat|feature)(\(.+\))?: ]]; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" =~ ^(fix|bugfix|patch)(\(.+\))?: ]]; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" =~ ^(build|ci|docs|style|refactor|perf|test|chore)(\(.+\))?: ]]; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          else
            # é»˜è®¤ä¸º patch å‡çº§
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          fi
      
      - name: Calculate new version
        id: new_version
        run: |
          MAJOR=${{ steps.current_version.outputs.major }}
          MINOR=${{ steps.current_version.outputs.minor }}
          PATCH=${{ steps.current_version.outputs.patch }}
          BUMP_TYPE=${{ steps.version_bump.outputs.bump_type }}
          
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ New version will be: $NEW_VERSION (bump: $BUMP_TYPE)"
      
      - name: Create and push tag
        id: tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»º tag
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION
          
          Auto-generated release from commit: ${{ github.sha }}
          Commit message: ${{ github.event.head_commit.message }}
          
          Changes in this release:
          - Built from main branch
          - All tests passed
          - Multi-platform builds included"
          
          # æ¨é€ tag
          git push origin "$NEW_VERSION"
          
          echo "new_tag=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_created=true" >> $GITHUB_OUTPUT
          echo "âœ… Created and pushed tag: $NEW_VERSION"

  # ============================================
  # å‘å¸ƒ Releaseï¼ˆæˆåŠŸå‡ ä¸ªå‘å¸ƒå‡ ä¸ªï¼‰
  # ============================================
  release:
    name: Create Release
    needs: [auto-tag, build-android, build-ios, build-web, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    # åªè¦ auto-tag æˆåŠŸå°±è¿è¡Œï¼Œä¸ç®¡æ„å»ºæ˜¯å¦å…¨éƒ¨æˆåŠŸ
    if: always() && needs.auto-tag.outputs.tag_created == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          echo "version=${{ needs.auto-tag.outputs.new_tag }}" >> $GITHUB_OUTPUT
      
      - name: Check build results
        id: build_status
        run: |
          echo "=== Build Status Summary ==="
          echo "Android: ${{ needs.build-android.result }}"
          echo "iOS: ${{ needs.build-ios.result }}"
          echo "Web: ${{ needs.build-web.result }}"
          echo "Windows: ${{ needs.build-windows.result }}"
          echo "macOS: ${{ needs.build-macos.result }}"
          echo "Linux: ${{ needs.build-linux.result }}"
          
          # ç»Ÿè®¡æˆåŠŸçš„æ„å»ºæ•°é‡
          SUCCESS_COUNT=0
          FAILED_BUILDS=""
          
          if [[ "${{ needs.build-android.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            FAILED_BUILDS="$FAILED_BUILDS Android"
          fi
          
          if [[ "${{ needs.build-ios.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            FAILED_BUILDS="$FAILED_BUILDS iOS"
          fi
          
          if [[ "${{ needs.build-web.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            FAILED_BUILDS="$FAILED_BUILDS Web"
          fi
          
          if [[ "${{ needs.build-windows.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            FAILED_BUILDS="$FAILED_BUILDS Windows"
          fi
          
          if [[ "${{ needs.build-macos.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            FAILED_BUILDS="$FAILED_BUILDS macOS"
          fi
          
          if [[ "${{ needs.build-linux.result }}" == "success" ]]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            FAILED_BUILDS="$FAILED_BUILDS Linux"
          fi
          
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "failed_builds=$FAILED_BUILDS" >> $GITHUB_OUTPUT
          echo ""
          echo "âœ… Successful builds: $SUCCESS_COUNT/6"
          if [[ -n "$FAILED_BUILDS" ]]; then
            echo "âŒ Failed builds:$FAILED_BUILDS"
          fi
      
      - name: Download Android artifact
        if: needs.build-android.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/android-apk/
        continue-on-error: true
      
      - name: Download iOS artifact
        if: needs.build-ios.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: artifacts/ios-build/
        continue-on-error: true
      
      - name: Download Web artifact
        if: needs.build-web.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: artifacts/web-build/
        continue-on-error: true
      
      - name: Download Windows artifact
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: artifacts/windows-build/
        continue-on-error: true
      
      - name: Download macOS artifact
        if: needs.build-macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: artifacts/macos-build/
        continue-on-error: true
      
      - name: Download Linux artifact
        if: needs.build-linux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: artifacts/linux-build/
        continue-on-error: true
      
      - name: Prepare release files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p release
          
          # Android APK
          if [ -d "artifacts/android-apk" ]; then
            cp artifacts/android-apk/*.apk release/ 2>/dev/null || true
            echo "âœ… Android APK added"
          fi
          
          # iOS
          if [ -d "artifacts/ios-build" ]; then
            cd artifacts/ios-build && zip -r "../../release/RemoteDesktop-$VERSION-ios.zip" . && cd ../..
            echo "âœ… iOS build added"
          fi
          
          # Web
          if [ -d "artifacts/web-build" ]; then
            cd artifacts/web-build && zip -r "../../release/RemoteDesktop-$VERSION-web.zip" . && cd ../..
            echo "âœ… Web build added"
          fi
          
          # Windows
          if [ -d "artifacts/windows-build" ]; then
            cp artifacts/windows-build/*.zip release/ 2>/dev/null || true
            echo "âœ… Windows build added"
          fi
          
          # macOS
          if [ -d "artifacts/macos-build" ]; then
            cp artifacts/macos-build/*.dmg release/ 2>/dev/null || true
            cp artifacts/macos-build/*.zip release/ 2>/dev/null || true
            echo "âœ… macOS build added"
          fi
          
          # Linux
          if [ -d "artifacts/linux-build" ]; then
            cp artifacts/linux-build/*.tar.gz release/ 2>/dev/null || true
            echo "âœ… Linux build added"
          fi
          
          echo ""
          echo "=== Release files ==="
          ls -la release/ || echo "No release files found"
      
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SUCCESS_COUNT="${{ steps.build_status.outputs.success_count }}"
          FAILED_BUILDS="${{ steps.build_status.outputs.failed_builds }}"
          
          # ç”Ÿæˆå¯ç”¨å¹³å°åˆ—è¡¨
          AVAILABLE_PLATFORMS=""
          if [ -f "release/"*"-android.apk" ] 2>/dev/null; then
            AVAILABLE_PLATFORMS="$AVAILABLE_PLATFORMS\n| Android | \`*-android.apk\` | ç›´æ¥å®‰è£… APK |"
          fi
          if [ -f "release/"*"-ios.zip" ] 2>/dev/null; then
            AVAILABLE_PLATFORMS="$AVAILABLE_PLATFORMS\n| iOS | \`*-ios.zip\` | éœ€è¦ Xcode ç­¾å |"
          fi
          if [ -f "release/"*"-web.zip" ] 2>/dev/null; then
            AVAILABLE_PLATFORMS="$AVAILABLE_PLATFORMS\n| Web | \`*-web.zip\` | éƒ¨ç½²åˆ° Web æœåŠ¡å™¨ |"
          fi
          if [ -f "release/"*"-windows"* ] 2>/dev/null; then
            AVAILABLE_PLATFORMS="$AVAILABLE_PLATFORMS\n| Windows | \`*-windows-x64.zip\` | è§£å‹åè¿è¡Œ exe |"
          fi
          if [ -f "release/"*"-macos"* ] 2>/dev/null; then
            AVAILABLE_PLATFORMS="$AVAILABLE_PLATFORMS\n| macOS | \`*-macos.dmg\` | åŒå‡»å®‰è£… |"
          fi
          if [ -f "release/"*"-linux"* ] 2>/dev/null; then
            AVAILABLE_PLATFORMS="$AVAILABLE_PLATFORMS\n| Linux | \`*-linux-x64.tar.gz\` | è§£å‹åè¿è¡Œ \`./run.sh\` |"
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          cat > release_notes.md << EOF
          ## ğŸš€ Remote Desktop $VERSION
          
          **æ„å»ºçŠ¶æ€**: $SUCCESS_COUNT/6 å¹³å°æ„å»ºæˆåŠŸ
          
          ### ğŸ“¦ å¯ç”¨ä¸‹è½½ / Available Downloads
          
          | å¹³å° / Platform | æ–‡ä»¶ / File | è¯´æ˜ / Notes |
          |----------------|-------------|--------------|
          $(echo -e "$AVAILABLE_PLATFORMS")
          
          EOF
          
          if [[ -n "$FAILED_BUILDS" ]]; then
            cat >> release_notes.md << EOF
          
          ### âš ï¸ æœªèƒ½æ„å»ºçš„å¹³å° / Failed Builds
          
          ä»¥ä¸‹å¹³å°æ„å»ºå¤±è´¥ï¼Œå°†åœ¨åç»­ç‰ˆæœ¬ä¸­ä¿®å¤ï¼š$FAILED_BUILDS
          
          EOF
          fi
          
          cat >> release_notes.md << EOF
          
          ---
          *æ­¤ç‰ˆæœ¬ç”± CI è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          EOF
          
          cat release_notes.md
      
      - name: Create Release
        if: steps.build_status.outputs.success_count != '0'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Remote Desktop ${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Skip release (no successful builds)
        if: steps.build_status.outputs.success_count == '0'
        run: |
          echo "âš ï¸ No successful builds to release"
          echo "All platform builds failed. Please check the build logs."
          exit 1

  # ============================================
  # éƒ¨ç½² Web åˆ° GitHub Pages
  # ============================================
  deploy-web:
    name: Deploy to GitHub Pages
    needs: [build-web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build/
      
      - name: Setup Pages
        id: setup-pages
        uses: actions/configure-pages@v4
        continue-on-error: true
      
      - name: Check Pages setup
        if: steps.setup-pages.outcome == 'failure'
        run: |
          echo "âš ï¸ GitHub Pages setup failed. This might be because:"
          echo "1. GitHub Pages is not enabled for this repository"
          echo "2. Insufficient permissions to configure Pages"
          echo "3. Repository settings need to be updated"
          echo ""
          echo "To fix this:"
          echo "1. Go to repository Settings > Pages"
          echo "2. Enable GitHub Pages with 'GitHub Actions' as source"
          echo "3. Ensure the workflow has 'pages: write' and 'id-token: write' permissions"
          exit 1
      
      - name: Upload to Pages
        if: steps.setup-pages.outcome == 'success'
        uses: actions/upload-pages-artifact@v3
        with:
          path: web-build/
      
      - name: Deploy to GitHub Pages
        if: steps.setup-pages.outcome == 'success'
        id: deployment
        uses: actions/deploy-pages@v4
