name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

env:
  FLUTTER_VERSION: '3.24.0'
  RUST_VERSION: 'stable'

jobs:
  # ============================================
  # Rust Core 测试和构建
  # ============================================
  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxrandr-dev libxcursor-dev libxi-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Run tests
        run: cargo test --all --verbose
      
      - name: Build release
        run: cargo build --release

  # ============================================
  # Flutter 测试
  # ============================================
  flutter-test:
    name: Flutter Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
      
      - name: Run tests
        run: |
          set +e
          timeout 300 flutter test --coverage 2>&1 | tee test_output.txt
          TEST_EXIT=$?
          # 强制终止可能残留的 dart 进程
          pkill -f "dart" || true
          if grep -q "tests passed" test_output.txt; then
            echo "✅ All tests passed"
            exit 0
          elif [ $TEST_EXIT -eq 124 ]; then
            echo "⚠️ Tests timed out but may have passed"
            if grep -q "All tests passed" test_output.txt; then
              exit 0
            fi
            exit 1
          else
            exit $TEST_EXIT
          fi
        timeout-minutes: 8
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: flutter-client/coverage/lcov.info
          flags: flutter
          fail_ci_if_error: false

  # ============================================
  # 微信小程序测试
  # ============================================
  miniprogram-test:
    name: WeChat Miniprogram Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: wechat-miniprogram
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: wechat-miniprogram/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test -- --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: wechat-miniprogram/coverage/lcov.info
          flags: miniprogram
          fail_ci_if_error: false


  # ============================================
  # Flutter 多平台构建
  # ============================================
  build-android:
    name: Build Android
    needs: [rust-test, flutter-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle
        run: flutter build appbundle --release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: flutter-client/build/app/outputs/flutter-apk/app-release.apk
      
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: flutter-client/build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS
    needs: [rust-test, flutter-test]
    runs-on: macos-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign
      
      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: flutter-client/build/ios/iphoneos/

  build-web:
    name: Build Web
    needs: [rust-test, flutter-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Web
        run: flutter build web --release
      
      - name: Upload Web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: flutter-client/build/web/

  build-windows:
    name: Build Windows
    needs: [rust-test, flutter-test]
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Windows
        run: flutter build windows --release
      
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: flutter-client/build/windows/x64/runner/Release/

  build-macos:
    name: Build macOS
    needs: [rust-test, flutter-test]
    runs-on: macos-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build macOS
        run: flutter build macos --release
      
      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: flutter-client/build/macos/Build/Products/Release/

  build-linux:
    name: Build Linux
    needs: [rust-test, flutter-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: flutter-client
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Linux
        run: flutter build linux --release
      
      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: flutter-client/build/linux/x64/release/bundle/


  # ============================================
  # 发布 Release
  # ============================================
  release:
    name: Create Release
    needs: [build-android, build-ios, build-web, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Package artifacts
        run: |
          cd artifacts
          zip -r android-apk.zip android-apk/
          zip -r android-aab.zip android-aab/
          zip -r ios-build.zip ios-build/
          zip -r web-build.zip web-build/
          zip -r windows-build.zip windows-build/
          zip -r macos-build.zip macos-build/
          zip -r linux-build.zip linux-build/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/android-apk.zip
            artifacts/android-aab.zip
            artifacts/ios-build.zip
            artifacts/web-build.zip
            artifacts/windows-build.zip
            artifacts/macos-build.zip
            artifacts/linux-build.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # 部署 Web 到 GitHub Pages
  # ============================================
  deploy-web:
    name: Deploy to GitHub Pages
    needs: [build-web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build/
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: web-build/
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
